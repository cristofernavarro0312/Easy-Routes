<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Routes - Sistema Optimizado</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 1.4em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #map {
            height: 600px;
            border-radius: 10px;
        }
        
        .results {
            display: none;
            margin-top: 25px;
            animation: slideIn 0.3s ease;
        }
        
        .results.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .result-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }
        
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõµ Easy Routes - Sistema de Optimizaci√≥n</h1>
            <p class="subtitle">Proyecto de Matem√°ticas Discretas - Grafos y Algoritmo de Dijkstra</p>
        </div>
        
        <div class="main-grid">
            <!-- Panel de Control -->
            <div class="panel">
                <h2 class="section-title">üìç Planificar Ruta</h2>
                
                <div class="form-group">
                    <label>üü¢ Punto de Origen</label>
                    <select id="origen">
                        <option value="">-- Seleccionar origen --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üî¥ Punto de Destino</label>
                    <select id="destino">
                        <option value="">-- Seleccionar destino --</option>
                    </select>
                </div>
                
                <button class="btn" onclick="calcularRuta()">
                    üîç Calcular Ruta √ìptima
                </button>
                
                <div id="results" class="results">
                    <div class="result-card">
                        <div class="result-label">‚è±Ô∏è Tiempo Estimado</div>
                        <div class="result-value" id="tiempo">-- min</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">üìè Distancia Total</div>
                        <div class="result-value" id="distancia">-- km</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">üíµ Tarifa Estimada</div>
                        <div class="result-value" id="tarifa">S/ --</div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <span>Intersecciones:</span>
                            <strong id="pasos">--</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span>Velocidad prom:</span>
                            <strong id="velocidad">-- km/h</strong>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>üí° Nota del Proyecto:</strong><br>
                    Este sistema usa el algoritmo de Dijkstra para encontrar el camino m√°s corto considerando tiempo, distancia y congesti√≥n del tr√°fico.
                </div>
            </div>
            
            <!-- Mapa -->
            <div class="panel">
                <h2 class="section-title">üó∫Ô∏è Mapa Interactivo</h2>
                <div id="map"></div>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Cargando red de calles...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuraci√≥n
        const LUGARES_CLAVE = [
            {id: 'mundialito', nombre: 'Campo El Mundialito', lat: -11.8549, lon: -77.0683},
            {id: 'humantanga', nombre: 'Mercado Humantanga', lat: -11.8621, lon: -77.0716},
            {id: 'plazavea', nombre: 'Plaza Vea', lat: -11.8627, lon: -77.0708},
            {id: 'colca', nombre: 'La Colca San Lorenzo', lat: -11.8422, lon: -77.0651},
            {id: 'piramide', nombre: 'Ladrillos Pir√°mide', lat: -11.8576, lon: -77.0585},
            {id: 'tranquera', nombre: 'Tranquera Santa Rosa', lat: -11.8542, lon: -77.0689},
            {id: 'miraflores', nombre: 'Parque Miraflores', lat: -11.8517, lon: -77.0726},
            {id: 'tunas', nombre: 'Mercado Las Tunas', lat: -11.8531, lon: -77.0724},
            {id: 'sanjose', nombre: 'Mercado San Jos√© Carabayllo', lat: -11.8683, lon: -77.0681},
            {id: 'lomas', nombre: 'Mercado Mayorista Lomas', lat: -11.8689, lon: -77.0690}
        ];
        
        let map, grafo = {}, nodos = {}, capasRuta = [];
        
        // Calcular distancia Haversine
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Generar red de calles (simulada)
   async function cargarGrafo() {
       const response = await fetch('grafo_web.json');
       const datos = await response.json();
       nodos = datos.nodos;
       grafo = datos.grafo;
       inicializarMapa();
   }
            
            // Grid de intersecciones
            const latMin = -11.87, latMax = -11.84;
            const lonMin = -77.08, lonMax = -77.05;
            const paso = 0.003; // ~300m
            
            let nodeId = 0;
            const todosNodos = [];
            
            for (let lat = latMin; lat <= latMax; lat += paso) {
                for (let lon = lonMin; lon <= lonMax; lon += paso) {
                    const id = `n${nodeId++}`;
                    nodosTemp[id] = {
                        id: id,
                        lat: lat,
                        lon: lon,
                        tipo: 'interseccion',
                        nombre: `Intersecci√≥n ${nodeId}`
                    };
                    todosNodos.push(id);
                }
            }
            
            // Conectar nodos cercanos
            todosNodos.forEach(id1 => {
                grafoTemp[id1] = {};
                todosNodos.forEach(id2 => {
                    if (id1 === id2) return;
                    
                    const dist = calcularDistancia(
                        nodosTemp[id1].lat, nodosTemp[id1].lon,
                        nodosTemp[id2].lat, nodosTemp[id2].lon
                    );
                    
                    if (dist < 400) {
                        const tiempo = dist / 16.67; // 20 km/h
                        const congestion = 1.0 + Math.random() * 0.5;
                        
                        grafoTemp[id1][id2] = {
                            dist: dist,
                            tiempo: tiempo,
                            congestion: congestion
                        };
                    }
                });
            });
            
            return {nodos: nodosTemp, grafo: grafoTemp};
        }
        
        // Encontrar nodo m√°s cercano
        function encontrarNodoMasCercano(lat, lon) {
            let minDist = Infinity;
            let mejorNodo = null;
            
            for (let id in nodos) {
                if (nodos[id].tipo === 'interseccion') {
                    const dist = calcularDistancia(lat, lon, nodos[id].lat, nodos[id].lon);
                    if (dist < minDist) {
                        minDist = dist;
                        mejorNodo = id;
                    }
                }
            }
            
            return {nodo: mejorNodo, distancia: minDist};
        }
        
        // Algoritmo de Dijkstra
        function dijkstra(origen, destino) {
            const distancias = {};
            const previos = {};
            const visitados = new Set();
            const todosNodos = Object.keys(nodos);
            
            todosNodos.forEach(n => distancias[n] = Infinity);
            distancias[origen] = 0;
            
            while (true) {
                let actual = null;
                let menorDist = Infinity;
                
                todosNodos.forEach(n => {
                    if (!visitados.has(n) && distancias[n] < menorDist) {
                        menorDist = distancias[n];
                        actual = n;
                    }
                });
                
                if (!actual || menorDist === Infinity) break;
                if (actual === destino) break;
                
                visitados.add(actual);
                
                if (grafo[actual]) {
                    for (let vecino in grafo[actual]) {
                        if (!visitados.has(vecino)) {
                            const peso = grafo[actual][vecino].tiempo * grafo[actual][vecino].congestion;
                            const nuevaDist = distancias[actual] + peso;
                            
                            if (nuevaDist < distancias[vecino]) {
                                distancias[vecino] = nuevaDist;
                                previos[vecino] = actual;
                            }
                        }
                    }
                }
            }
            
            const ruta = [];
            let actual = destino;
            while (actual) {
                ruta.unshift(actual);
                actual = previos[actual];
            }
            
            return {ruta: ruta, tiempo: distancias[destino]};
        }
        
        // Inicializar aplicaci√≥n
        function inicializar() {
            // Generar red
            const red = generarRedCalles();
            nodos = red.nodos;
            grafo = red.grafo;
            
            // Integrar lugares clave
            LUGARES_CLAVE.forEach(lugar => {
                nodos[lugar.id] = {
                    id: lugar.id,
                    nombre: lugar.nombre,
                    lat: lugar.lat,
                    lon: lugar.lon,
                    tipo: 'poi'
                };
                
                const cercano = encontrarNodoMasCercano(lugar.lat, lugar.lon);
                
                if (cercano.nodo && cercano.distancia < 500) {
                    grafo[lugar.id] = {};
                    grafo[lugar.id][cercano.nodo] = {
                        dist: cercano.distancia,
                        tiempo: cercano.distancia / 1.4,
                        congestion: 1.0
                    };
                    
                    if (!grafo[cercano.nodo]) grafo[cercano.nodo] = {};
                    grafo[cercano.nodo][lugar.id] = {
                        dist: cercano.distancia,
                        tiempo: cercano.distancia / 1.4,
                        congestion: 1.0
                    };
                }
            });
            
            // Poblar selectores
            const selectOrigen = document.getElementById('origen');
            const selectDestino = document.getElementById('destino');
            
            LUGARES_CLAVE.forEach(lugar => {
                const opt1 = document.createElement('option');
                opt1.value = lugar.id;
                opt1.textContent = lugar.nombre;
                selectOrigen.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = lugar.id;
                opt2.textContent = lugar.nombre;
                selectDestino.appendChild(opt2);
            });
            
            // Inicializar mapa
            inicializarMapa();
        }
        
        // Inicializar mapa Leaflet
        function inicializarMapa() {
            map = L.map('map').setView([-11.8550, -77.0670], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            // Dibujar conexiones (calles)
            for (let n1 in grafo) {
                for (let n2 in grafo[n1]) {
                    if (nodos[n1] && nodos[n2]) {
                        L.polyline([
                            [nodos[n1].lat, nodos[n1].lon],
                            [nodos[n2].lat, nodos[n2].lon]
                        ], {
                            color: '#bdc3c7',
                            weight: 1,
                            opacity: 0.2
                        }).addTo(map);
                    }
                }
            }
            
            // Dibujar POIs
            LUGARES_CLAVE.forEach(lugar => {
                L.circleMarker([lugar.lat, lugar.lon], {
                    radius: 8,
                    fillColor: '#e74c3c',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map).bindPopup(`<b>${lugar.nombre}</b>`);
            });
            
            document.getElementById('loading').style.display = 'none';
        }
        
        // Calcular ruta
        function calcularRuta() {
            const origenId = document.getElementById('origen').value;
            const destinoId = document.getElementById('destino').value;
            
            if (!origenId || !destinoId) {
                alert('Selecciona origen y destino');
                return;
            }
            
            if (origenId === destinoId) {
                alert('Origen y destino deben ser diferentes');
                return;
            }
            
            const resultado = dijkstra(origenId, destinoId);
            
            if (!resultado.ruta || resultado.ruta.length === 0) {
                alert('No se encontr√≥ ruta');
                return;
            }
            
            // Calcular m√©tricas
            let distanciaTotal = 0;
            for (let i = 0; i < resultado.ruta.length - 1; i++) {
                const n1 = resultado.ruta[i];
                const n2 = resultado.ruta[i + 1];
                if (grafo[n1] && grafo[n1][n2]) {
                    distanciaTotal += grafo[n1][n2].dist;
                }
            }
            
            const tiempoMin = resultado.tiempo / 60;
            const tarifaBase = 3.0;
            const tarifaDist = (distanciaTotal / 1000) * 2.0;
            const tarifaTiempo = tiempoMin * 0.2;
            const tarifaTotal = tarifaBase + tarifaDist + tarifaTiempo;
            const velocidadProm = distanciaTotal > 0 ? ((distanciaTotal/1000) / (tiempoMin/60)) : 0;
            
            // Mostrar resultados
            document.getElementById('tiempo').textContent = `${tiempoMin.toFixed(1)} min`;
            document.getElementById('distancia').textContent = `${(distanciaTotal/1000).toFixed(2)} km`;
            document.getElementById('tarifa').textContent = `S/ ${tarifaTotal.toFixed(2)}`;
            document.getElementById('pasos').textContent = resultado.ruta.length;
            document.getElementById('velocidad').textContent = `${velocidadProm.toFixed(1)} km/h`;
            
            document.getElementById('results').classList.add('show');
            
            // Dibujar ruta
            dibujarRuta(resultado.ruta);
        }
        
        // Dibujar ruta en mapa
        function dibujarRuta(ruta) {
            capasRuta.forEach(capa => map.removeLayer(capa));
            capasRuta = [];
            
            for (let i = 0; i < ruta.length - 1; i++) {
                const n1 = nodos[ruta[i]];
                const n2 = nodos[ruta[i + 1]];
                
                if (n1 && n2) {
                    const linea = L.polyline([
                        [n1.lat, n1.lon],
                        [n2.lat, n2.lon]
                    ], {
                        color: '#e74c3c',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    capasRuta.push(linea);
                }
            }
            
            const puntos = ruta.map(id => [nodos[id].lat, nodos[id].lon]);
            map.fitBounds(puntos, {padding: [50, 50]});
            
            // Marcadores inicio/fin
            const inicio = L.marker([nodos[ruta[0]].lat, nodos[ruta[0]].lon], {
                icon: L.divIcon({
                    html: '<div style="background:#27ae60;color:white;padding:5px 10px;border-radius:5px;font-weight:bold;">üèÅ INICIO</div>',
                    iconSize: [80, 30],
                    iconAnchor: [40, 30]
                })
            }).addTo(map);
            capasRuta.push(inicio);
            
            const fin = L.marker([nodos[ruta[ruta.length-1]].lat, nodos[ruta[ruta.length-1]].lon], {
                icon: L.divIcon({
                    html: '<div style="background:#e74c3c;color:white;padding:5px 10px;border-radius:5px;font-weight:bold;">üéØ DESTINO</div>',
                    iconSize: [100, 30],
                    iconAnchor: [50, 30]
                })
            }).addTo(map);
            capasRuta.push(fin);
        }
        
        // Iniciar al cargar
        window.addEventListener('load', inicializar);
    </script>
</body>
</html>